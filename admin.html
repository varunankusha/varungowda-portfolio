<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin — VarunGowda</title>
    <link rel="stylesheet" href="assets/css/styles.css" />
    <style>
      .admin { width: min(900px, 92%); margin: 32px auto; }
      .admin h1 { margin-bottom: 12px; }
      .gate { display: grid; gap: 10px; max-width: 420px; }
      .row { display: grid; gap: 8px; margin: 12px 0; }
      .muted { color: var(--muted); }
      .list { display: grid; gap: 10px; }
      .item { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 12px; }
      .item small { color: var(--muted); }
      .flex { display:flex; gap:8px; flex-wrap: wrap; }
      .split { display:grid; grid-template-columns: 1fr 1fr; gap: 16px; }
      @media (max-width: 780px){ .split{ grid-template-columns: 1fr; } }
    </style>
  </head>
  <body>
    <div class="admin">
      <h1>Admin</h1>
      <p class="muted">Local-only admin. Data is saved in your browser using localStorage.</p>

      <section id="auth">
        <div class="gate">
          <label for="pwd">Enter admin password</label>
          <input id="pwd" type="password" placeholder="Password" />
          <button class="btn primary" id="loginBtn">Unlock</button>
        </div>
      </section>

      <section id="content" style="display:none;">
        <div class="split">
          <div>
            <h2>Gallery</h2>
            <div class="row">
              <label>Type</label>
              <select id="gType">
                <option value="image">Image</option>
                <option value="video">Video</option>
              </select>
            </div>
            <div class="row">
              <label>Source URL</label>
              <input id="gSrc" placeholder="https://... or relative path" />
            </div>
            <div class="row">
              <label>Alt/Caption</label>
              <input id="gAlt" placeholder="Description (optional)" />
            </div>
            <div class="flex">
              <button class="btn" id="addGallery">Add to Gallery</button>
              <button class="btn ghost" id="clearGallery">Clear Gallery</button>
            </div>
            <div class="list" id="galleryList"></div>
          </div>

          <div>
            <h2>Polls</h2>
            <div class="row">
              <label>Question</label>
              <input id="pQuestion" placeholder="Your question" />
            </div>
            <div class="row">
              <label>Options (comma-separated)</label>
              <input id="pOptions" placeholder="Yes,No,Maybe" />
            </div>
            <div class="flex">
              <button class="btn" id="addPoll">Create Poll</button>
              <button class="btn ghost" id="clearPolls">Clear Polls</button>
            </div>
            <div class="list" id="pollsAdminList"></div>
          </div>
        </div>

        <div class="row" style="margin-top:16px;">
          <button class="btn primary" id="pushToSite">Save & Update Site</button>
          <small class="muted">Opens or updates the main page with your changes.</small>
        </div>

        <div class="row" style="margin-top:16px;">
          <h3>Export / Import</h3>
          <div class="flex">
            <button class="btn" id="exportData">Export JSON</button>
            <label class="btn ghost" for="importFile" style="cursor:pointer;">Import JSON</label>
            <input id="importFile" type="file" accept="application/json" style="display:none;" />
          </div>
          <small class="muted">Use this to transfer your gallery and polls to another device.</small>
        </div>
      </section>
    </div>

    <script>
      const PASSWORD = 'neelamma';

      const storage = {
        get(key, fallback){ try { return JSON.parse(localStorage.getItem(key)||'') ?? fallback; } catch { return fallback; } },
        set(key, value){ localStorage.setItem(key, JSON.stringify(value)); }
      };

      const authSec = document.getElementById('auth');
      const contentSec = document.getElementById('content');
      const loginBtn = document.getElementById('loginBtn');
      const pwdInput = document.getElementById('pwd');

      loginBtn.addEventListener('click', () => {
        if (pwdInput.value === PASSWORD) {
          authSec.style.display = 'none';
          contentSec.style.display = 'block';
          loadLists();
        } else {
          alert('Incorrect password');
        }
      });

      // Gallery controls
      const addGalleryBtn = document.getElementById('addGallery');
      const clearGalleryBtn = document.getElementById('clearGallery');
      const gType = document.getElementById('gType');
      const gSrc = document.getElementById('gSrc');
      const gAlt = document.getElementById('gAlt');
      const galleryList = document.getElementById('galleryList');

      addGalleryBtn.addEventListener('click', () => {
        const items = storage.get('galleryItems', []);
        if (!gSrc.value) return alert('Please enter a source URL');
        items.push({ type: gType.value, src: gSrc.value, alt: gAlt.value });
        storage.set('galleryItems', items);
        gSrc.value = ''; gAlt.value = '';
        loadGalleryList();
      });

      clearGalleryBtn.addEventListener('click', () => {
        if (!confirm('Clear all gallery items?')) return;
        storage.set('galleryItems', []);
        loadGalleryList();
      });

      function loadGalleryList(){
        galleryList.innerHTML = '';
        // Try Supabase view
        withSupabase(async (sb) => {
          const { data, error } = await sb.from('gallery_items').select('*').order('created_at', { ascending: false });
          if (!error && data) {
            data.forEach((it) => {
              const div = document.createElement('div');
              div.className = 'item';
              div.innerHTML = `<strong>${it.type.toUpperCase()}</strong> — ${it.storage_url} <br/><small>${it.alt||''}</small>`;
              const actions = document.createElement('div');
              actions.className = 'flex';
              const del = document.createElement('button'); del.className='btn small'; del.textContent='Delete';
              del.addEventListener('click', async () => {
                const { error: e } = await sb.from('gallery_items').delete().eq('id', it.id);
                if (e) return alert('Failed to delete');
                loadGalleryList();
              });
              actions.appendChild(del);
              div.appendChild(actions);
              galleryList.appendChild(div);
            });
            return;
          }
          // Fallback local
          const items = storage.get('galleryItems', []);
          items.forEach((it, idx) => {
            const div = document.createElement('div');
            div.className = 'item';
            div.innerHTML = `<strong>${it.type.toUpperCase()}</strong> — ${it.src} <br/><small>${it.alt||''}</small>`;
            const actions = document.createElement('div');
            actions.className = 'flex';
            const del = document.createElement('button'); del.className='btn small'; del.textContent='Delete';
            del.addEventListener('click', () => {
              const items = storage.get('galleryItems', []);
              items.splice(idx,1);
              storage.set('galleryItems', items);
              loadGalleryList();
            });
            actions.appendChild(del);
            div.appendChild(actions);
            galleryList.appendChild(div);
          });
        });
      }

      // Polls controls
      const addPollBtn = document.getElementById('addPoll');
      const clearPollsBtn = document.getElementById('clearPolls');
      const pQuestion = document.getElementById('pQuestion');
      const pOptions = document.getElementById('pOptions');
      const pollsAdminList = document.getElementById('pollsAdminList');

      addPollBtn.addEventListener('click', () => {
        const polls = storage.get('polls', []);
        const q = (pQuestion.value||'').trim();
        const opts = (pOptions.value||'').split(',').map(s => s.trim()).filter(Boolean).map(t => ({ text: t, votes: 0 }));
        if (!q || !opts.length) return alert('Enter question and at least one option');
        polls.push({ question: q, options: opts });
        storage.set('polls', polls);
        pQuestion.value = ''; pOptions.value = '';
        loadPollsList();
      });

      clearPollsBtn.addEventListener('click', () => {
        if (!confirm('Clear all polls?')) return;
        storage.set('polls', []);
        loadPollsList();
      });

      function loadPollsList(){
        pollsAdminList.innerHTML = '';
        withSupabase(async (sb) => {
          const { data: polls, error: e1 } = await sb.from('polls').select('*').order('created_at', { ascending: false });
          if (!e1 && polls) {
            for (const p of polls) {
              const { data: opts } = await sb.from('poll_options').select('*').eq('poll_id', p.id);
              const div = document.createElement('div');
              div.className = 'item';
              div.innerHTML = `<strong>${p.question}</strong><br/><small>${(opts||[]).map(o=>o.text).join(', ')}</small>`;
              const actions = document.createElement('div');
              actions.className = 'flex';
              const del = document.createElement('button'); del.className='btn small'; del.textContent='Delete';
              del.addEventListener('click', async () => {
                const { error: e } = await sb.from('polls').delete().eq('id', p.id);
                if (e) return alert('Failed to delete');
                loadPollsList();
              });
              actions.appendChild(del);
              div.appendChild(actions);
              pollsAdminList.appendChild(div);
            }
            return;
          }
          // Fallback local
          const localPolls = storage.get('polls', []);
          localPolls.forEach((p, idx) => {
            const div = document.createElement('div');
            div.className = 'item';
            div.innerHTML = `<strong>${p.question}</strong><br/><small>${p.options.map(o=>o.text).join(', ')}</small>`;
            const actions = document.createElement('div');
            actions.className = 'flex';
            const del = document.createElement('button'); del.className='btn small'; del.textContent='Delete';
            del.addEventListener('click', () => {
              const arr = storage.get('polls', []);
              arr.splice(idx,1);
              storage.set('polls', arr);
              loadPollsList();
            });
            actions.appendChild(del);
            div.appendChild(actions);
            pollsAdminList.appendChild(div);
          });
        });
      }

      function loadLists(){ loadGalleryList(); loadPollsList(); }

      const pushBtn = document.getElementById('pushToSite');
      pushBtn.addEventListener('click', () => {
        const data = {
          gallery: storage.get('galleryItems', []),
          polls: storage.get('polls', [])
        };
        try {
          if (window.opener) {
            window.opener.postMessage({ type: 'updateGallery', payload: data.gallery }, '*');
            window.opener.postMessage({ type: 'updatePolls', payload: data.polls }, '*');
            alert('Updated the main page. Switch to it to see changes.');
          } else {
            window.open('index.html', '_blank');
            alert('Opened the main page. Your data is already saved.');
          }
        } catch (e) {
          alert('Could not message the main page. Open index.html and try again.');
        }
      });

      // Export / Import
      const exportBtn = document.getElementById('exportData');
      const importInput = document.getElementById('importFile');

      exportBtn.addEventListener('click', () => {
        const blob = new Blob([JSON.stringify({
          galleryItems: storage.get('galleryItems', []),
          polls: storage.get('polls', [])
        }, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'site-data.json';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      });

      importInput.addEventListener('change', async () => {
        const file = importInput.files && importInput.files[0];
        if (!file) return;
        try {
          const text = await file.text();
          const data = JSON.parse(text);
          if (data.galleryItems) storage.set('galleryItems', data.galleryItems);
          if (data.polls) storage.set('polls', data.polls);
          loadLists();
          if (window.opener) {
            window.opener.postMessage({ type: 'updateGallery', payload: storage.get('galleryItems', []) }, '*');
            window.opener.postMessage({ type: 'updatePolls', payload: storage.get('polls', []) }, '*');
          }
          alert('Imported data. Reload homepage to see updates.');
        } catch (e) {
          alert('Failed to import JSON');
        } finally {
          importInput.value = '';
        }
      });

      // Supabase integration (optional)
      const supaScript = document.createElement('script');
      supaScript.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
      document.body.appendChild(supaScript);

      async function ensureSupabaseLoaded(){
        if (window.supabase) return true;
        await new Promise((resolve) => supaScript.addEventListener('load', resolve, { once: true }));
        return !!window.supabase;
      }

      async function withSupabase(cb){
        try {
          const res = await fetch('supabase/supabaseConfig.json', { cache: 'no-store' });
          if (!res.ok) return null;
          const cfg = await res.json();
          const ok = await ensureSupabaseLoaded();
          if (!ok) return null;
          const { createClient } = window.supabase;
          return cb(createClient(cfg.url, cfg.anonKey));
        } catch { return null; }
      }

      // If Supabase is present, wire quick actions
      addGalleryBtn.addEventListener('click', async (e) => {
        const using = await withSupabase(async (sb) => {
          if (!gSrc.value) return false;
          const { error } = await sb.from('gallery_items').insert({ type: gType.value, storage_url: gSrc.value, alt: gAlt.value || null });
          if (error) { alert('Supabase error adding gallery item: ' + (error.message || 'unknown')); return true; }
          alert('Added to Supabase gallery.');
          gSrc.value = ''; gAlt.value = '';
          return true;
        });
        if (using) {
          e.stopImmediatePropagation();
          e.preventDefault();
        }
      }, { capture: true });

      addPollBtn.addEventListener('click', async (e) => {
        const using = await withSupabase(async (sb) => {
          const q = (pQuestion.value||'').trim();
          const opts = (pOptions.value||'').split(',').map(s => s.trim()).filter(Boolean);
          if (!q || !opts.length) return false;
          const { data: poll, error: e1 } = await sb.from('polls').insert({ question: q }).select('*').single();
          if (e1) { alert('Supabase error creating poll'); return true; }
          const rows = opts.map(text => ({ poll_id: poll.id, text }));
          const { error: e2 } = await sb.from('poll_options').insert(rows);
          if (e2) { alert('Supabase error adding options'); return true; }
          alert('Poll created in Supabase.');
          pQuestion.value = ''; pOptions.value = '';
          return true;
        });
        if (using) {
          e.stopImmediatePropagation();
          e.preventDefault();
        }
      }, { capture: true });

    </script>
  </body>
</html> 